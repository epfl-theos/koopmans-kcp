<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">

<!--Converted with LaTeX2HTML 2002-2-1 (1.71)
original version by:  Nikos Drakos, CBLU, University of Leeds
* revised and updated by:  Marcus Hennecke, Ross Moore, Herb Swan
* with significant contributions from:
  Jens Lippmann, Marek Rouchal, Martin Wilck and others -->
<HTML>
<HEAD>
<TITLE>8.6 Self Consistency</TITLE>
<META NAME="description" CONTENT="8.6 Self Consistency">
<META NAME="keywords" CONTENT="user_guide">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">

<META NAME="Generator" CONTENT="LaTeX2HTML v2002-2-1">
<META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">

<LINK REL="STYLESHEET" HREF="user_guide.css">

<LINK REL="next" HREF="node77.html">
<LINK REL="previous" HREF="node75.html">
<LINK REL="up" HREF="node70.html">
<LINK REL="next" HREF="node77.html">
</HEAD>

<BODY >
<!--Navigation Panel-->
<A NAME="tex2html1362"
  HREF="node77.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.gif"></A> 
<A NAME="tex2html1358"
  HREF="node70.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.gif"></A> 
<A NAME="tex2html1352"
  HREF="node75.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.gif"></A> 
<A NAME="tex2html1360"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.gif"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html1363"
  HREF="node77.html">8.7 Phonons</A>
<B> Up:</B> <A NAME="tex2html1359"
  HREF="node70.html">8 Frequently Asked Questions</A>
<B> Previous:</B> <A NAME="tex2html1353"
  HREF="node75.html">8.5 Frequent errors during</A>
   <B>  <A NAME="tex2html1361"
  HREF="node1.html">Contents</A></B> 
<BR>
<BR>
<!--End of Navigation Panel-->
<!--Table of Child-Links-->
<A NAME="CHILD_LINKS"><STRONG>Subsections</STRONG></A>

<UL>
<LI><UL>
<LI><A NAME="tex2html1364"
  HREF="node76.html#SECTION00096010000000000000">8.6.0.1 ''What are the units for quantity XYZ?''</A>
<LI><A NAME="tex2html1365"
  HREF="node76.html#SECTION00096020000000000000">8.6.0.2 ''Self-consistency is slow or does not converge at all''</A>
<LI><A NAME="tex2html1366"
  HREF="node76.html#SECTION00096030000000000000">8.6.0.3  ''How is the charge density (the potential, etc.) stored? What position in real space corresponds to an array value?''</A>
<LI><A NAME="tex2html1367"
  HREF="node76.html#SECTION00096040000000000000">8.6.0.4  ''What is the difference between total and absolute
  magnetization?''</A>
<LI><A NAME="tex2html1368"
  HREF="node76.html#SECTION00096050000000000000">8.6.0.5  ''How can I calculate magnetic moments for each atom?''</A>
<LI><A NAME="tex2html1369"
  HREF="node76.html#SECTION00096060000000000000">8.6.0.6  ''What is the order of <I>Y</I><SUB>lm</SUB>
<tex2html_verbatim_mark> components in projected
  DOS / projection of atomic wavefunctions?''</A>
<LI><A NAME="tex2html1370"
  HREF="node76.html#SECTION00096070000000000000">8.6.0.7  ''Why is the sum of partial Lowdin charges not equal to
  the total charge?''</A>
<LI><A NAME="tex2html1371"
  HREF="node76.html#SECTION00096080000000000000">8.6.0.8  ''Why do I get a strange value of the Fermi energy?''</A>
<LI><A NAME="tex2html1372"
  HREF="node76.html#SECTION00096090000000000000">8.6.0.9 ''Why I don't get zero pressure/stress at equilibrium?''</A>
<LI><A NAME="tex2html1373"
  HREF="node76.html#SECTION000960100000000000000">8.6.0.10  ''Why do I get "negative starting charge"?'' </A>
<LI><A NAME="tex2html1374"
  HREF="node76.html#SECTION000960110000000000000">8.6.0.11 ''How do I calculate the work function?''</A>
</UL></UL>
<!--End of Table of Child-Links-->
<HR>

<H2><A NAME="SECTION00096000000000000000">
8.6 Self Consistency</A>
</H2>

<P>

<H4><A NAME="SECTION00096010000000000000">
8.6.0.1 ''What are the units for quantity XYZ?''</A>
</H4>
''A:''' Unless otherwise specified, all PWscf input and output
quantities are in atomic "Rydberg" units, i.e. energies in Ry, lengths
in Bohr radii, etc.. Note that CP uses instead atomic "Hartree" units:
energies in Ha, lengths in Bohr radii. 

<P>

<H4><A NAME="SECTION00096020000000000000">
8.6.0.2 ''Self-consistency is slow or does not converge at all''</A>
</H4>
'''A:''' Bad input data will often result in bad scf
convergence. Please check your structure first.

<P>
Assuming that your input data is sensible :

<OL>
<LI>Verify if your system is metallic or is close to a metallic
  state, especially if you have few k-points. If the highest occupied
  and lowest unoccupied state(s) keep exchanging place during
  self-consistency, forget about reaching convergence. A typical sign
  of such behavior is that the self-consistency error goes down, down,
  down, than all of a sudden up again, and so on. Usually one can
  solve the problem by adding a few empty bands and a small
  broadening. 
</LI>
<LI>Reduce mixing beta from the default value (0.7) to <!-- MATH
 $\sim 0.3\div
0.1$
 -->
<IMG
 WIDTH="20" HEIGHT="19" ALIGN="BOTTOM" BORDER="0"
 SRC="img7.gif"
 ALT="$ \sim$"> 0.3 &#247; 0.1
<tex2html_verbatim_mark> or smaller. Try the mixing mode value that is more
  appropriate for your problem. For slab geometries used in surface
  problems or for elongated cells, mixing
  mode='local-TF' should be the better choice,
  dampening "charge sloshing". You may also try to increase mixing
  ndim to more than 8 (default value). Beware: the larger mixing ndim,
  the larger the amount of memory you need. 
</LI>
<LI>Specific to US PP: the presence of negative charge density
  regions due to either the pseudization procedure of the augmentation
  part or to truncation at finite cutoff may give convergence
  problems. Raising the ecutrho cutoff for charge density will usually
  help, especially in gradient-corrected calculations. 
</LI>
</OL>

<P>

<H4><A NAME="SECTION00096030000000000000">
8.6.0.3  ''How is the charge density (the potential, etc.) stored? What position in real space corresponds to an array value?''</A>
</H4>
'''A:''' The index of arrays used to store functions defined on 3D meshes is
actually a shorthand for three indeces, following the FORTRAN convention ("leftmost index runs faster"). An example will explain this better. Suppose you have a 3D array of dimension (nr1,nr2,nr3), say psi(nr1,nr2,nr3). FORTRAN compilers store this array sequentially in the computer RAM in the following way:
<PRE>
        psi(1,1,1)
        psi(2,1,1)
        ...
        psi(nr1,1,1)
        psi(1,2,1)
        psi(2,2,1)
        ...
        psi(nr1,2,1)
        ...
        psi(nr1,nr2,1)
        psi(1,1,nr3)
etc
</PRE>
Let ind be the position of the (i,j,k) element in the above list: the
relation between ind and (i,j,k) is:
<PRE>
        ind = i + (j + 1) * nr1 + (k + 1) *  nr2 * nr1
</PRE>
This should clarify the relation between 1D and 3D indexing. In real
space, the (i,j,k) point of the mesh is
<P><!-- MATH
 \begin{displaymath}
r_{ijk}=\frac{i-1}{nr1} \tau_1  +  \frac{j-1}{nr2} \tau_2 +
\frac{k-1}{nr3} \tau_3
\end{displaymath}
 -->
</P>
<DIV ALIGN="CENTER">
<I>r</I><SUB>ijk</SUB> = <IMG
 WIDTH="48" HEIGHT="61" ALIGN="MIDDLE" BORDER="0"
 SRC="img11.gif"
 ALT="$\displaystyle {\frac{{i-1}}{{nr1}}}$"><IMG
 WIDTH="21" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img12.gif"
 ALT="$\displaystyle \tau_{1}^{}$"> + <IMG
 WIDTH="50" HEIGHT="61" ALIGN="MIDDLE" BORDER="0"
 SRC="img13.gif"
 ALT="$\displaystyle {\frac{{j-1}}{{nr2}}}$"><IMG
 WIDTH="21" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img14.gif"
 ALT="$\displaystyle \tau_{2}^{}$"> + <IMG
 WIDTH="52" HEIGHT="61" ALIGN="MIDDLE" BORDER="0"
 SRC="img15.gif"
 ALT="$\displaystyle {\frac{{k-1}}{{nr3}}}$"><IMG
 WIDTH="21" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img16.gif"
 ALT="$\displaystyle \tau_{3}^{}$">
</DIV><P>
<tex2html_verbatim_mark></P>
where the <IMG
 WIDTH="18" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img17.gif"
 ALT="$ \tau_{i}^{}$">
<tex2html_verbatim_mark> are the basis vectors of the Bravais lattice. The latter
are stored row-wise in the "AT" array:

<P>
<IMG
 WIDTH="21" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img18.gif"
 ALT="$ \tau_{1}^{}$"> =
<tex2html_verbatim_mark> at(:, 1), <I>tau</I><SUB>2</SUB> =
<tex2html_verbatim_mark> at(:, 2), <IMG
 WIDTH="21" HEIGHT="33" ALIGN="MIDDLE" BORDER="0"
 SRC="img19.gif"
 ALT="$ \tau_{3}^{}$"> =
<tex2html_verbatim_mark> at(:, 3)

<P>
(info by Stefano Baroni)

<P>

<H4><A NAME="SECTION00096040000000000000">
8.6.0.4  ''What is the difference between total and absolute
  magnetization?''</A>
</H4> 

<P>
'''A:''' The total magnetization is the integral of the magnetization
in the cell: 
<P><!-- MATH
 \begin{displaymath}
M_T = \int (n_{up}-n_{down}) d^3r.
\end{displaymath}
 -->
</P>
<DIV ALIGN="CENTER">
<I>M</I><SUB>T</SUB> = <IMG
 WIDTH="21" HEIGHT="55" ALIGN="MIDDLE" BORDER="0"
 SRC="img20.gif"
 ALT="$\displaystyle \int$">(<I>n</I><SUB>up</SUB> - <I>n</I><SUB>down</SUB>)<I>d</I><SUP>3</SUP><I>r</I>.
</DIV><P>
<tex2html_verbatim_mark></P>
The absolute magnetization is the integral of the absolute value of
the magnetization in the cell:
<P><!-- MATH
 \begin{displaymath}
M_A= \int |n_{up}-n_{down}| d^3r.
\end{displaymath}
 -->
</P>
<DIV ALIGN="CENTER">
<I>M</I><SUB>A</SUB> = <IMG
 WIDTH="21" HEIGHT="55" ALIGN="MIDDLE" BORDER="0"
 SRC="img20.gif"
 ALT="$\displaystyle \int$">| <I>n</I><SUB>up</SUB> - <I>n</I><SUB>down</SUB>| <I>d</I><SUP>3</SUP><I>r</I>.
</DIV><P>
<tex2html_verbatim_mark></P>
In a simple ferromagnetic material they should be equal (except
possibly for an overall sign)`. In simple antiferromagnets (like FeO,
NiO) <I>M</I><SUB>T</SUB>
<tex2html_verbatim_mark> is zero and <I>M</I><SUB>A</SUB>
<tex2html_verbatim_mark> is twice the magnetization of each of the
two atoms. (info by Stefano de Gironcoli) 

<P>

<H4><A NAME="SECTION00096050000000000000">
8.6.0.5  ''How can I calculate magnetic moments for each atom?''</A>
</H4> 
'''A:''' There is no 'right' way of defining the local magnetic moment
around an atom in a multi-atom system. However an approximate way to define
it is via the projected density of states on the atomic orbitals (code
projwfc.x, see example08 for its use as a postprocessing tool). This
code generate many files with the density of states projected on each
atomic wavefunction of each atom and a BIG amount of data on the
standard output, the last few lines of which contain the decomposition
of Lowdin charges on angular momentum and spin component of each atom.

<P>

<H4><A NAME="SECTION00096060000000000000">
8.6.0.6  ''What is the order of <I>Y</I><SUB>lm</SUB>
<tex2html_verbatim_mark> components in projected
  DOS / projection of atomic wavefunctions?''</A>
</H4> 
'''A:''' "The order is, I think:
<PRE>
    1   $P_{0,0}(t)$
    2   $P_{1,0}(t)$
    3   $P_{1,1}(t)cos\phi$
    4   $P_{1,1}(t)sin\phi$ 
    5   $P_{2,0}(t)$
    6   $P_{2,1}(t)cos\phi$ 
    7   $P_{2,1}(t)sin\phi$
    8   $P_{2,2}(t)cos2\phi$
    9   $P_{2,2}(t)sin2\phi$
</PRE>
and so on; <I>P</I><SUB>l, m</SUB>
<tex2html_verbatim_mark>=Legendre Polynomials, <!-- MATH
 $t = cos\theta = z/r$
 -->
<I>t</I> = <I>cos</I><IMG
 WIDTH="14" HEIGHT="20" ALIGN="BOTTOM" BORDER="0"
 SRC="img21.gif"
 ALT="$ \theta$"> = <I>z</I>/<I>r</I>
<tex2html_verbatim_mark>, 
<!-- MATH
 $\phi= atan(y /x)$
 -->
<IMG
 WIDTH="16" HEIGHT="35" ALIGN="MIDDLE" BORDER="0"
 SRC="img22.gif"
 ALT="$ \phi$"> = <I>atan</I>(<I>y</I>/<I>x</I>)
<tex2html_verbatim_mark>. No warranty. Anybody really interested in knowing 
''for sure'' which spherical harmonic combination is which should look 
into routine ylmr2 in flib/ylmr2.f90". 

<P>

<H4><A NAME="SECTION00096070000000000000">
8.6.0.7  ''Why is the sum of partial Lowdin charges not equal to
  the total charge?''</A>
</H4> 

<P>
"Lowdin charges (as well as other conventional atomic charges) do not
satisfy any sum rule. You can easily convince yourself that ths is the
case because the atomic orbitals that are used to calculate them are
arbitrary to some extent. If yu like, you can think that the missing
charge is "delocalized" or "bonding" charge, but this would be another
way of naming the conventional (to some extent) character of Lowdin
charge." (Stefano Baroni, Sept. 2008).  

<P>
See also the definition of "spilling parameter": Sanchez-Portal et
al., Sol. State Commun. 95, 685 (1995). The spilling parameter
measures the ability of the basis provided by the pseudo-atomic wfc to
represent the PW eigenstates, by measuring how much of the subspace of
the Hamiltonian eigenstates falls outside the subspace spanned by the
atomic basis. 

<P>

<H4><A NAME="SECTION00096080000000000000">
8.6.0.8  ''Why do I get a strange value of the Fermi energy?''</A>
</H4>
"The value of the Fermi energy (as well as of any energy, for that
matter) depends of the reference level. What you are referring to is
probably the "Fermi energy referred to the vacuum level" (i.e.  
the work function). In order to obtain that, you need to know what the
vacuum level is, which cannot be said from a bulk calculation only"
(Stefano Baroni, Sept. 2008). 

<P>

<H4><A NAME="SECTION00096090000000000000">
8.6.0.9 ''Why I don't get zero pressure/stress at equilibrium?''</A>
</H4>
It depends. If you make a calculation with fixed cell parameters, you
will never get exactly zero pressure/stress, unless you use the cell
that yields perfect equilibrium for your pseudopotentials,  cutoffs,
k-points, etc.. Such cell will anyway be slightly different from the
experimental one. Note however that pressures/stresses in the order of
a few KBar correspond to very small differences in terms of lattice parameters.

<P>
If you obtain the equilibrium cell from a variable-cell optimization,
do not forget that the pressure/stress calculated with the modified
kinetic energy functional (very useful for variable-cell calculations)
slightly differ from those calculated without it. 

<P>

<H4><A NAME="SECTION000960100000000000000">
8.6.0.10  ''Why do I get "negative starting charge"?'' </A>
</H4>
Self-consistency requires an initial guess for the charge density in
order to bootstrap the iterative algorithm. This first guess is
usually built from a superposition of atomic charges, constructed from
pseudopotential data. 

<P>
More often than not, this charges are a slightly too hard to be
expanded very accurately in plane waves, hence some aliasing error
will be introduced. Especially if the unit cell is big and mostly
empty, some local low negative charge density will be produced. 

<P>
''This is NOT harmful at all, the negative charge density is handled
properly by the code and will disappear during the self-consistent
cycles'', but if it is very high (let's say more than 0.001*number of
electrons) it may be a symptom that your charge density cutoff is too
low. (L. Paulatto - November 2008)

<P>

<H4><A NAME="SECTION000960110000000000000">
8.6.0.11 ''How do I calculate the work function?''</A>
</H4>
Work function = (average potential in the vacuum) - (Fermi
Energy). The former is estimated in a supercell with the slab
geometry, by looking at the average of the electrostatic potential
(typically without the XC part). See the example in
examples/WorkFct_example. 

<P>
<HR>
<!--Navigation Panel-->
<A NAME="tex2html1362"
  HREF="node77.html">
<IMG WIDTH="37" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="next" SRC="next.gif"></A> 
<A NAME="tex2html1358"
  HREF="node70.html">
<IMG WIDTH="26" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="up" SRC="up.gif"></A> 
<A NAME="tex2html1352"
  HREF="node75.html">
<IMG WIDTH="63" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="previous" SRC="prev.gif"></A> 
<A NAME="tex2html1360"
  HREF="node1.html">
<IMG WIDTH="65" HEIGHT="24" ALIGN="BOTTOM" BORDER="0" ALT="contents" SRC="contents.gif"></A>  
<BR>
<B> Next:</B> <A NAME="tex2html1363"
  HREF="node77.html">8.7 Phonons</A>
<B> Up:</B> <A NAME="tex2html1359"
  HREF="node70.html">8 Frequently Asked Questions</A>
<B> Previous:</B> <A NAME="tex2html1353"
  HREF="node75.html">8.5 Frequent errors during</A>
   <B>  <A NAME="tex2html1361"
  HREF="node1.html">Contents</A></B> 
<!--End of Navigation Panel-->
<ADDRESS>
Paolo Giannozzi
2009-07-19
</ADDRESS>
</BODY>
</HTML>

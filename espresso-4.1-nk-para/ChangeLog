
=======================================================
		NK code:  Log of Changes
=======================================================


Mar 07 2012     partial cleanup of CG and nksiclib, in order to speedup the innerloop part.(AF)

Feb 23 2012     cp_restarted slightly changed to allow WanT postprocessing. (AF)

Feb 20 2012     convg_outer.dat is written only if iprsta > 1 (ie verbosity="high"). (AF)

Feb 16 2012     Bug fixed in the calculation of PBE0 and B3LYP energies (hfscalfact missing
		in the calculation of the exx term). The bug didn't affect at all the
		eigenvalues and eigenvectors (the force term was already correct).
		Reference results for tests 02 and 05 updated accordingly. (AF)

Feb 04 2012     Changed a minor flavor in CG outer loop routine.  Not rotating
		the conjugate gradient vector according to the inner loop rotation
		gives us a better convergence result (empirically).  This version
		comments out the rotation of the conjugate gradient vector. (CHP)

Feb 03 2012     Fixed bugs in CG routine for SIC.  Mainly, pc2 has been replaced
		by pc3, which is an wavefunction orthonormalization routine
		suitable for ODD density functionals.  Previous pc2 does not alllow
		the unitary transform between wavefunctions in the occupied
		manifold. Approximate, analytical Lowdin orthogonalization has
		been performed in pc3. (CHP)

Oct 25 2011     Cleanup of unused variables and consistency check in
		nksiclib.f90. Few bugs (eg real-complex mismatch of bec) fixed. (AF)

Aug 10 2011     Fixed a bug for nspin=2 and no spin-symmetrized case (before, the
		SIC force was calculated with a wrong index for vsic(:,i) in the
		case of inner loop minimization. (CHP)

Aug 04 2011     Fixed three bugs.
		innerloop_dd_nstep, innerloop_cg_nsd, innerloop_cg_nreset was
		previous defined LOGICAL in Modules/input_parameters.f90 (thanks Iss).
		In inner loop CG routine, (1) nspin was considered in dE/d(step).
		and (2) we stop the minimization if CG step increases the energy
		without reducing the step size, etc. (CHP)

Aug 02 2011     Conjugate gradient inner loop minimization implemented.
		Inner loop CG routine can be run with parabolic minimization
		and also without parabolic minimization: the latter should be used
		when using nk0 or any SIC method without an energy functional.
		Fractional occupation is not yet implemented.  (This is the case
		even for the original cp code's conjugate gradient routine.) (CHP)

Jun 18 2011     inner loop minimization for SIC implemented for damped dynamics.
		An optimal unitary rotation among occupied states is calculated
		when the variable do_innerloop in the namelist SYSTEM of the
		input file is set .true.  Convergence for this inner loop
		minimization and (conventional) outer loop minimization can be
		found in the files convg_inner.dat and convg_outer.dat, respectively.

		Nota Bene: This inner-loop minimization cannot be used for the
		case where an energy functional cannot be defined like nk0. (CHP)

May 04 2011     bug fixed in nksiclib for calculations with fractional numbers
		of electrons. The numerical check of the Janak's theorem is 
		now working. (AF)

Feb 09 2011     references updated in test03. (AF)

Feb 08 2011     references updated in test01 and test02. The total energy of 
		PBE0 is not working properly. (AF)

Jan 28 2011     calc_dipole routine simplified (rhor is no longer recomputed). 
		Anyway, the do_efield implementation seems not to be working;
		use tefield (Berry phases) instead. (AF) 

Jan 21 2011     rhobarfact implementation removed. Further optimization
		implemented (such as nksic_hartree_drv) to reduce repeated code. 
		Cleanup of unused variables done in nksiclib. Reshufling of parts
		of the calculations introduced. (AF)

Jan 19 2011     energies in cp are printed out with 10 digits instead of 5.
		This is fundamental to extract hyperpolarizabilities from
		total energy fittings. (AF)

Dec 19 2010     nksiclib and hflib embedded in modules, to have a better
		check on the interfaces of subroutines. (AF)

Dec 14 2010     PBE0 and B3LYP functionals implemented in cp. 
		Tests 02 and 05 updated. (AF)

Dec 13 2010     Routine to compute empty states restored and re-added.
		Test05 added to demonstrate how to use it and compare with the
		traditional way of compute empty states using occupations from input. 

		IMPORTANT CHANGE: exx and pink energies are added now after 
		their calculation (not before as it used to be). This means
		that the dynamics is not going to be exactly the same, while
		the converged results should be. (AF)

Nov 24 2010     Bug fixed in the initialization of deeq_sic: it was affecting
		the random wfc at startup when do_nk=T (harmless anyway). (AF)

Nov 22 2010     USPP implementation made effective. (AF)

Nov 21 2010     Test suite added to repository. Extensive checks on the
		historical versions performed starting from Jan 16 2010. (AF)

Nov 18 2010     Smearing in cp further implemented. It is working with 
		normal functionals but not yet with orbital-dependent functionals.                                  
		Bug found in the USPP implementation of NK. Changes to fix some of the
		problems added (nksic_newd, nksic_eforce). 
		Further testing to be done. (AF)

Oct 10 2010     USPP implementation cleaned up, bugs fixed, but implementation
		*not* yet properly working.
		A simple implementation of eDFT added (occupations='smearing'). (AF)

Oct 09 2010     Problems with USPP implementation:
		c-precompiler macros used to deal with double-grid implementation 
		removed. (AF)

Aug 24 2010     GGA implementation for NK started: calculation of the 
		gradients added consistently in all the nksic library.
		Bug fixed in printout.f90;
		Possible values for   which_orbdep  further updated.
		HF has been strongly optimized:  nspin=1 is working; 
		memory requirements as well as cpu time (# of fft) reduced. (AF)

Aug 21 2010     which_orbdep variable added.
		Preliminary (but compiling) implementation of nki. (AF)

Aug 19 2010     Input for NKC (now called: orbital dependent part) inproved:
		do_nk, do_pz, do_nkpz, do_nki vars added; we still miss a global high
		level variable  which_orbdep.                                        
		PZ taken out of NK and cast in a separate routine (optimized as well).
		nksic_potential subroutine shaped in such a way to deal with         
		different kinds of orbital dependent functionals (nk, nk0, nki, pz,  
		nkpz).
		pz nkc mixing removed.                                               
		Tests performed for pz and nk, serial/parallel. (AF)

Aug 19 2010     PZ functionality fixed when using (f_ref=0 and rhobarfact=0.0);
		Bug fixed in PZ when using nkmix. 
		update_rhoref functionality removed. (AF)

Aug 06 2010     US pseudopotentials implemented in CP. NK(PZ) implemented in CP. 
		NK(PZ) implemented in LD1. Option do_nkmix removed in LD1. 
		This version must be tested to verify that files 
		have been correctly merged. (ID)

Jul 25 2010     NKC + PZ mixing re-added to nksiclib. (AF)

Jun 30 2010     Pi terms were computed wrongly for occupations different
		from 1  ( f /= 1 ). This was not affecting the NKC hamiltonian.
		but only the total energies.  (AF)  

Jun 13 2010     Bugs fixed in the case nspin=1: eigenvalues were not correct,
		they were printed out divided by 2.0; 
		NKC + nspin=1 + nbnd odd resulted in an out-of-bound error. (AF)

May 28 2010     Bug fixed in efield+nspin=1 . Now nspin=1,nspin=2 are
		exactly the same if do_spinsym=.TRUE. is used. This fix 
		re-include the changes added on Feb 17 2010. (AF)

May 20 2010     Important optimization of the NK subroutines done. (AF)
		This involved major changes in nksiclib.f90 to optimize
		both the speed and the memory usage of the code.
		nspin=1 and nspin=2 calculations work in the same way.

		ATTENTION: the defaults of some of the variables 
		(fref and rhobarfact) have been changed to more standard
		values (0.5 and 1.0 respectively). Input that works after
		this date may not work for previous versions.

May 11 2010     Bug in the CVS code fixed. Results consistent again
		with code from Feb 16 2010 (which means that the bug 
		in the nspin=2 electric enthalpy implementation is still there).
		do_wref and do_wxd vars added. (ID)

Apr 21 2010     CVS repository started (on qe-forge). (ID)
		CVSROOT: :ext:<user>@cvs.qe-forge.org:/cvsroot/nkc 
		where <user> is the developer username on qe-forge
		Version of the code from Feb 16 (and not from Feb 17) used.
		A new bug is present anyway, and the results are not the same.

Feb 17 2010     Dipole due to electric field was miscalculated (a missing 1/2
		factor) when nspin=2 due to the occupation prefactors. 
		The problem is now fixed. (AF)

Feb 16 2010     Changes by Ismaila. (ID)
		NOTE: this is the version of the code
		that will be used (by mistake) to start the CVS repository.

Jan 26 2010     Several corrections in the NK-CPV and NK-LD1 code. (ID)
		in particular, the Hartree contribution was missing from the 
		w_ref potential in addition to various numerical problems). 
		The AlphaNK and hybrid EXX functionals have been implemented. 
		The agreement between finite-difference and analytical energy 
		derivatives (with resp is now verified).

Nov 25 2009     Implementation of interatomic forces in NK-CPV 
		using tricubic interpolation. (ID)

Nov 14 2009     Parallelization of the NK-CPV code. (AF)
		ee_mod renamed eecp_mod to avoid confusion with ee_mod in EE 
		and allow automatic dependency generation.
		writetofile is active only with high and medium verbosity.

Sep 2009        Full implementation of the method in CPV
and before      and LD1. (ID)
